<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitoring Suhu & Kelembapan</title>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link href="https://cdn.datatables.net/1.13.1/css/dataTables.bootstrap4.min.css" rel="stylesheet"/>
<style>
body { 
  padding-top: 56px; 
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.sidebar { 
  height: 100vh; 
  background: linear-gradient(180deg, #343a40 0%, #495057 100%); 
  color: white; 
  position: fixed; 
  top: 56px; 
  left: 0; 
  width: 220px; 
  padding-top: 1rem; 
  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}
.sidebar a { 
  color: white; 
  display: block; 
  padding: 12px 15px; 
  text-decoration: none; 
  transition: all 0.3s ease;
}
.sidebar a:hover { 
  background-color: #495057; 
  transform: translateX(5px);
}
.content { 
  margin-left: 220px; 
  padding: 2rem 3rem; 
  min-height: calc(100vh - 56px);
}
.card-icon { 
  font-size: 4rem; 
  opacity: 0.3; 
  transition: opacity 0.3s ease;
}
.card:hover .card-icon { 
  opacity: 0.6; 
}
.card { 
  border: none; 
  border-radius: 15px; 
  box-shadow: 0 8px 20px rgba(0,0,0,0.1); 
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card:hover { 
  transform: translateY(-5px); 
  box-shadow: 0 12px 30px rgba(0,0,0,0.2);
}
.card.bg-info { 
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); 
}
.card.bg-success { 
  background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); 
}
.card.bg-warning { 
  background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); 
  box-shadow: 0 0 20px rgba(255, 193, 7, 0.3);
}
.footer { 
  text-align: center; 
  padding: 15px; 
  margin-top: 50px; 
  font-size: 0.9rem; 
  color: #666; 
  border-top: 1px solid #ddd; 
  background: rgba(255,255,255,0.8);
}
.status-indicator { 
  font-weight: bold; 
}
.status-online { 
  color: #28a745; 
}
.status-offline { 
  color: #dc3545; 
}
.alert-status { 
  border-radius: 10px; 
  animation: fadeIn 1s ease-in-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
.page { 
  animation: fadeIn 0.5s ease-in-out; 
}
/* Styling khusus untuk Statistik */
.chart-container { 
  position: relative; 
  margin: auto; 
  height: 400px; 
  width: 100%; 
}
canvas { 
  border-radius: 10px; 
  box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
  background: rgba(255,255,255,0.9);
}
/* Styling khusus untuk Tabel */
.table-responsive { 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
}
.table { 
  margin-bottom: 0; 
}
.table thead th { 
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); 
  color: white; 
  border: none; 
  font-weight: bold;
}
.table tbody tr:hover { 
  background-color: rgba(0,123,255,0.1); 
  transform: scale(1.01); 
  transition: all 0.2s ease;
}
.table-striped tbody tr:nth-of-type(odd) { 
  background-color: rgba(0,0,0,0.02); 
}
/* ===============================
   RESPONSIVE MODE MOBILE
   =============================== */
@media (max-width: 768px) {

  /* Sidebar di HP menjadi slide */
  .sidebar {
    width: 200px;
    left: -200px;
    top: 56px;
    position: fixed;
    height: calc(100vh - 56px);
    transition: left 0.3s ease;
    z-index: 2000;
  }

  .sidebar.active {
    left: 0;
  }

  /* Konten tidak terdorong */
  .content {
    margin-left: 0 !important;
    padding: 1.2rem !important;
  }

  /* Kartu lebih kecil */
  .card h2 {
    font-size: 1.8rem;
  }

  /* Chart lebih proporsional */
  .chart-container {
    height: 280px;
  }

  /* Tombol menu tampil */
  .btn-toggle-menu {
    display: inline-block !important;
    font-size: 24px;
    margin-right: 15px;
    cursor: pointer;
  }
}

/* Sembunyikan tombol menu di desktop */
.btn-toggle-menu {
  display: none;
}
</style>
</head>
<body>
<nav class="navbar navbar-expand navbar-dark bg-primary fixed-top">
  <span class="btn-toggle-menu text-white mr-3">
    <i class="fas fa-bars"></i>
  </span>

  <a class="navbar-brand" href="#">Monitoring</a>

  <span class="ml-auto text-white mr-3">
    WiFi: <span id="wifi-status" class="status-indicator status-offline">Offline</span> |
    Firebase: <span id="firebase-status" class="status-indicator status-offline">Offline</span>
  </span>
</nav>


<div class="sidebar">
  <a href="#" id="menu-home"><i class="fas fa-home"></i> Home</a>
  <a href="#" id="menu-tabel"><i class="fas fa-table"></i> Tabel</a>
  <a href="#" id="menu-statistik"><i class="fas fa-chart-bar"></i> Statistik</a>
</div>

<div class="content">
  <!-- HOME -->
  <div id="page-home" class="page">
    <h4 class="text-center mb-4">Monitoring <small class="text-muted">Suhu & Kelembapan</small></h4>
    
    <div id="status-alert" class="alert alert-info alert-status mb-4" role="alert">
      <i class="fas fa-info-circle"></i> <strong>Status Sistem:</strong> WiFi: <span id="wifi-status-alert">Offline</span> | Firebase: <span id="firebase-status-alert">Offline</span>
    </div>
    
    <div class="row my-4 justify-content-center">
      <div class="col-lg-5 col-md-6 mb-4">
        <div class="card bg-info text-white h-100">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
              <h2 id="display-temp" class="mb-1">-- °C</h2>
              <p class="mb-0">Suhu</p>
            </div>
            <div><i class="fas fa-thermometer-half card-icon"></i></div>
          </div>
        </div>
      </div>
      <div class="col-lg-5 col-md-6 mb-4">
        <div class="card bg-success text-white h-100">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
              <h2 id="display-humid" class="mb-1">-- %RH</h2>
              <p class="mb-0">Kelembapan</p>
            </div>
            <div><i class="fas fa-tint card-icon"></i></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="row justify-content-center">
      <div class="col-lg-6 col-md-8">
        <div class="card bg-warning text-white">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
              <h5 id="display-date" class="mb-1">--</h5>
              <p class="mb-0">Tanggal Update</p>
            </div>
            <div><i class="fas fa-calendar-check card-icon"></i></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TABEL -->
  <div id="page-tabel" class="page" style="display:none;">
    <h4 class="mb-4"><i class="fas fa-table text-primary"></i> Tabel <small class="text-muted">History Sensor</small></h4>
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table id="dataTable" class="table table-striped table-bordered w-100">
            <thead><tr><th>ID</th><th>Suhu (°C)</th><th>Kelembapan (%RH)</th><th>Tanggal</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- STATISTIK -->
  <div id="page-statistik" class="page" style="display:none;">
    <h4 class="mb-4"><i class="fas fa-chart-bar text-primary"></i> Statistik <small class="text-muted">Suhu & Kelembapan</small></h4>
    <div class="row">
      <div class="col-lg-6 mb-5">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title text-center"><i class="fas fa-thermometer-half text-info"></i> Grafik Suhu</h5>
            <div class="chart-container">
              <canvas id="chartTemp"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6 mb-5">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title text-center"><i class="fas fa-tint text-success"></i> Grafik Kelembapan</h5>
            <div class="chart-container">
              <canvas id="chartHumid"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="footer">Copyright © 2025. kupit_3D Detector All rights reserved.</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.1/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ===== Navigasi Menu =====
$("#menu-home").click(() => showPage('home'));
$("#menu-tabel").click(() => showPage('tabel'));
$("#menu-statistik").click(() => showPage('statistik'));
function showPage(page){$(".page").hide();$("#page-"+page).show();}

// ===== DataTable =====
let table = $('#dataTable').DataTable({ 
  pageLength:10, 
  order:[[0,"desc"]], 
  responsive: true, 
  language: { 
    search: "Cari:", 
    lengthMenu: "Tampilkan _MENU_ entri per halaman", 
    info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri" 
  }
});

// ===== Grafik =====
const chartTemp = new Chart(document.getElementById('chartTemp').getContext('2d'), {
  type:'line',
  data:{labels:[],datasets:[{label:'Suhu (°C)',data:[],borderColor:'rgba(54,162,235,1)',backgroundColor:'rgba(54,162,235,0.2)',fill:true,tension:0.25}]},
  options:{
    responsive:true,
    plugins: {
      legend: { position: 'top' },
      tooltip: { mode: 'index', intersect: false }
    },
    scales:{
      y:{beginAtZero:false, title: { display: true, text: 'Suhu (°C)' }},
      x:{title: { display: true, text: 'Waktu' }}
    },
    animation: { duration: 1000, easing: 'easeInOutQuad' }
  }
});
const chartHumid = new Chart(document.getElementById('chartHumid').getContext('2d'), {
  type:'line',
  data:{labels:[],datasets:[{label:'Kelembapan (%RH)',data:[],borderColor:'rgba(75,192,192,1)',backgroundColor:'rgba(75,192,192,0.2)',fill:true,tension:0.25}]},
  options:{
    responsive:true,
    plugins: {
      legend: { position: 'top' },
      tooltip: { mode: 'index', intersect: false }
    },
    scales:{
      y:{beginAtZero:false, title: { display: true, text: 'Kelembapan (%RH)' }},
      x:{title: { display: true, text: 'Waktu' }}
    },
    animation: { duration: 1000, easing: 'easeInOutQuad' }
  }
});

// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyAXS2J0OLvoCLwUwquy0xaWeSbYuHS-Gws",
  databaseURL: "https://sensor-suhu-ad146-default-rtdb.firebaseio.com/",
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const latestRef = db.ref("sensor/latest");
const historyRef = db.ref("sensor/history");

// ===== Fungsi Update Status =====
function updateStatus(wifi, firebase) {
  $('#wifi-status').text(wifi ? 'Online' : 'Offline');
  $('#firebase-status').text(firebase ? 'Online' : 'Offline');
  $('#wifi-status-alert').text(wifi ? 'Online' : 'Offline');
  $('#firebase-status-alert').text(firebase ? 'Online' : 'Offline');
  
  $('#wifi-status').removeClass('status-online status-offline').addClass(wifi ? 'status-online' : 'status-offline');
  $('#firebase-status').removeClass('status-online status-offline').addClass(firebase ? 'status-online' : 'status-offline');
  
  const alertClass = (wifi && firebase) ? 'alert-success' : (wifi || firebase) ? 'alert-warning' : 'alert-danger';
  $('#status-alert').removeClass('alert-info alert-success alert-warning alert-danger').addClass(alertClass);
}

// ===== Fungsi Cek WiFi/Internet =====
function checkWiFi() {
  const isOnline = navigator.onLine;
  updateStatus(isOnline, $('#firebase-status').text() === 'Online');
}

// ===== Event Listener untuk Real-Time Update Koneksi =====
window.addEventListener('online', () => {
  updateStatus(true, $('#firebase-status').text() === 'Online');
});
window.addEventListener('offline', () => {
  updateStatus(false, $('#firebase-status').text() === 'Online');
});

// ===== Listener Firebase untuk Data Terbaru =====
latestRef.on("value", snapshot => {
  const data = snapshot.val();
  if (data) {
    const suhu = (typeof data.suhu === 'number') ? data.suhu.toFixed(2) : '--';
    const hum = (typeof data.kelembapan === 'number') ? data.kelembapan.toFixed(2) : '--';
    const waktu = data.waktu || '--';

    $('#display-temp').text(suhu + ' °C');
    $('#display-humid').text(hum + ' %RH');
    $('#display-date').text(waktu);
  }
});

// ===== Listener Firebase untuk History =====
historyRef.on("value", snapshot => {
  const allData = snapshot.val();
  const nowUTC = Date.now() / 1000;
  const last24hUTC = nowUTC - (24 * 60 * 60);

  table.clear();
  chartTemp.data.labels = [];
  chartTemp.data.datasets[0].data = [];
  chartHumid.data.labels = [];
  chartHumid.data.datasets[0].data = [];

  if (allData) {
    Object.keys(allData)
      .map(k => Number(k))
      .sort((a, b) => a - b)
      .forEach(key => {
        const item = allData[key];
        const ts = item.timestamp || key;

        if (ts >= last24hUTC) {
          const suhu = item.suhu?.toFixed(2) || '--';
          const hum = item.kelembapan?.toFixed(2) || '--';
          const time = item.waktu || "--";

          table.row.add([key, suhu, hum, time]);
          chartTemp.data.labels.push(time);
          chartTemp.data.datasets[0].data.push(item.suhu);
          chartHumid.data.labels.push(time);
          chartHumid.data.datasets[0].data.push(item.kelembapan);
        }
      });
  }

  table.draw();
  chartTemp.update();
  chartHumid.update();
});

// ===== Cek Status Firebase =====
setInterval(() => {
  historyRef.once('value')
    .then(() => updateStatus(navigator.onLine, true))
    .catch(() => updateStatus(navigator.onLine, false));
}, 5000);

// ===== Inisialisasi =====
$(document).ready(() => { 
  showPage('home'); 
  checkWiFi();
});
// Tombol buka/tutup sidebar di HP
$(".btn-toggle-menu").click(function () {
  $(".sidebar").toggleClass("active");
});

</script>
</body>
</html>
